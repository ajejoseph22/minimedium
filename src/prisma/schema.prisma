datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

enum JobStatus {
  queued
  running
  partial
  succeeded
  failed
  cancelled
}

enum ImportExportFormat {
  ndjson
  json
}

enum ImportExportResource {
  users
  articles
  comments
}

enum ImportSourceType {
  upload
  url
}

model Article {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String
  body        String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  publishedAt DateTime?
  status      String    @default("draft")
  tagList     Tag[]
  author      User      @relation("UserArticles", fields: [authorId], onDelete: Cascade, references: [id])
  authorId    Int
  favoritedBy User[]    @relation("UserFavorites")
  comments    Comment[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  body      String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  articleId Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
}

model Tag {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  articles Article[]
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  username   String    @unique
  name       String?
  role       String    @default("user")
  active     Boolean   @default(true)
  password   String
  image      String?   @default("https://api.realworld.io/images/smiley-cyrus.jpeg")
  bio        String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @default(now()) @updatedAt
  articles   Article[] @relation("UserArticles")
  favorites  Article[] @relation("UserFavorites")
  followedBy User[]    @relation("UserFollows")
  following  User[]    @relation("UserFollows")
  comments   Comment[]
  importJobs ImportJob[]
  exportJobs ExportJob[]
  demo       Boolean   @default(false)
}

model ImportJob {
  id               String               @id @default(uuid())
  status           JobStatus            @default(queued)
  resource         ImportExportResource
  format           ImportExportFormat
  sourceType       ImportSourceType
  sourceLocation   String?
  fileName         String?
  fileSize         Int?
  requestHash      String?
  idempotencyKey   String?

  totalRecords     Int?
  processedRecords Int                  @default(0)
  successCount     Int                  @default(0)
  errorCount       Int                  @default(0)

  errorSummary     Json?

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  startedAt        DateTime?
  finishedAt       DateTime?

  createdById      Int
  createdBy        User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)

  errors           ImportError[]

  @@unique([createdById, idempotencyKey, resource])
}

model ImportError {
  id          String   @id @default(uuid())
  jobId       String
  job         ImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  recordIndex Int
  recordId    String?
  errorCode   Int
  errorName   String
  message     String
  field       String?
  value       Json?
  details     Json?

  createdAt   DateTime @default(now())

}

model ExportJob {
  id               String               @id @default(uuid())
  status           JobStatus            @default(queued)
  resource         ImportExportResource
  format           ImportExportFormat

  filters          Json?
  fields           Json?

  totalRecords     Int?
  processedRecords Int                  @default(0)

  outputLocation   String?
  downloadUrl      String?
  fileSize         Int?
  expiresAt        DateTime?

  requestHash      String?
  idempotencyKey   String?

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  startedAt        DateTime?
  finishedAt       DateTime?

  createdById      Int
  createdBy        User                 @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([createdById, idempotencyKey, resource])
}
